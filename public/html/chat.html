<!DOCTYPE html>
<html lang="pt-br">

<head>
    <title>Chat Suporte - Manutech</title>
    <script src="../js/verificar_login.js"></script>
    <script type="module" src="../js/sessao.js" defer></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <link rel="stylesheet" href="../style/style.css">
    <link rel="stylesheet" href="../style/chat.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@100..900&display=swap" rel="stylesheet">
    <link rel="icon" href="../images/icons/icon_manutech.svg">

    <style>
        /* Área de rolagem das mensagens */
        #box-mensagens {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #f8f9fa; /* Fundo leve */
        }

        /* Área de contatos com rolagem */
        #lista-contatos-chat {
            max-height: 500px;
            overflow-y: auto;
        }

        /* Cursor de mãozinha nos contatos */
        .contato-chat {
            cursor: pointer;
            transition: background 0.2s;
        }
        .contato-chat:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Balões de mensagem */
        .msg1 { /* Recebida (Cliente) */
            align-self: flex-start;
            background-color: #e9ecef;
            color: black;
            padding: 10px 15px;
            border-radius: 15px;
            border-bottom-left-radius: 0;
            max-width: 70%;
        }

        .msg2 { /* Enviada (Eu/Suporte) */
            align-self: flex-end;
            background-color: #ff751f;
            color: white;
            padding: 10px 15px;
            border-radius: 15px;
            border-bottom-right-radius: 0;
            max-width: 70%;
        }
    </style>
</head>

<body>
    <header id="header-logado" class="fixed-top header-azul">
        <nav class="navbar navbar-expand-sm navbar-light bg-light">
            <div class="row content-navbar">
                <div class="col-8 col-sm-8 col-md-4 col-lg-2">
                    <div style="width: 100%;">
                        <a href="/index"><img src="../images/icons/logo-manutech.png" style="width: 100%;"></a>
                    </div>
                </div>
                <div class="d-md-block col-md-2 col-lg-2">
                    <div class="collapse navbar-collapse lista-header">
                        <ul class="navbar-nav me-auto mt-2 mt-lg-0 botoes-header">
                            <li class="nav-item"><a class="nav-link" href="/chamado">Manutenção</a></li>
                            <li class="nav-item"><a class="nav-link" href="/catalogo">Reposição</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div style="height: 100px;"></div> <main>
        <div class="row" style="margin: 0;">
            
            <div class="col-12 col-md-3 container-contatos" style="background-color: #0043ad; min-height: 80vh;">
                <h5 style="color: white; padding: 15px; text-align: center;">Atendimentos</h5>
                
                <div id="lista-contatos-chat">
                    <p style="color: white; text-align: center; margin-top: 20px;">Carregando...</p>
                </div>
            </div>

            <div class="col-12 col-md-9">
                <div class="container-conversa">
                    
                    <div class="header-conversa">
                        <img src="../images/icons/perfil.png">
                        <p class="nome-contato" id="nome-cliente-atual">Selecione um cliente ao lado</p>
                    </div>

                    <div id="box-mensagens">
                        </div>

                    <div class="row footer-conversa">
                        <div class="col">
                            <input id="texto-msg" class="enviar-msg" placeholder="Digite sua resposta..." type="text">
                            <input type="hidden" id="id-cliente-atual">
                        </div>
                        <div class="col centralizar-botao-enviar">
                            <button class="btn-enviar" onclick="enviarResposta()">Enviar</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

    <script>
        let intervaloAtualizacao = null; // Variável para controlar o timer

        // 1. CARREGAR LISTA DE CLIENTES (Barra Lateral)
        async function carregarContatos() {
            const token = localStorage.getItem('token');
            const listaDiv = document.getElementById('lista-contatos-chat');

            try {
                const response = await fetch('/api/chat/contatos', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const dados = await response.json();
                
                listaDiv.innerHTML = ""; // Limpa "Carregando..."

                if (dados.contatos.length === 0) {
                    listaDiv.innerHTML = '<p style="color:white; text-align:center;">Nenhuma mensagem recebida.</p>';
                    return;
                }

                dados.contatos.forEach(cliente => {
                    const div = document.createElement('div');
                    div.className = 'row contato-chat p-2 border-bottom border-secondary';
                    div.innerHTML = `
                        <div class="col-3"><img src="../images/icons/perfil.png" style="width: 40px;"></div>
                        <div class="col-9 d-flex align-items-center"><p style="color: white; margin: 0;">${cliente.nome}</p></div>
                    `;
                    
                    // Ao clicar, abre a conversa
                    div.onclick = () => abrirConversa(cliente.id, cliente.nome);
                    
                    listaDiv.appendChild(div);
                });
            } catch (error) { 
                console.error(error); 
                listaDiv.innerHTML = '<p style="color:white;">Erro ao carregar.</p>';
            }
        }

        // 2. ABRIR CONVERSA ESPECÍFICA
        function abrirConversa(idCliente, nomeCliente) {
            // Atualiza visualmente
            document.getElementById('nome-cliente-atual').innerText = nomeCliente;
            document.getElementById('id-cliente-atual').value = idCliente;
            
            // Gerencia o intervalo (para de atualizar o anterior e começa o novo)
            if(intervaloAtualizacao) clearInterval(intervaloAtualizacao);
            
            carregarMensagensDoCliente(idCliente);
            // Atualiza a cada 3 segundos
            intervaloAtualizacao = setInterval(() => carregarMensagensDoCliente(idCliente), 3000);
        }

        // 3. CARREGAR MENSAGENS DO CLIENTE SELECIONADO
        async function carregarMensagensDoCliente(idCliente) {
            const token = localStorage.getItem('token');
            const box = document.getElementById('box-mensagens');
            const usuarioLogado = JSON.parse(localStorage.getItem('usuario'));

            try {
                const response = await fetch(`/api/chat/conversa/${idCliente}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const dados = await response.json();

                if(dados.sucesso) {
                    box.innerHTML = ""; // Limpa tela
                    
                    dados.mensagens.forEach(msg => {
                        const souEu = msg.remetente_id === usuarioLogado.id;
                        
                        const div = document.createElement('div');
                        div.className = souEu ? 'msg2' : 'msg1';
                        div.innerText = msg.mensagem;
                        
                        // Adiciona nome se for mensagem do cliente
                        if(!souEu) {
                            div.innerHTML = `<strong>${msg.nome_remetente}:</strong><br>${msg.mensagem}`;
                        }

                        box.appendChild(div);
                    });
                    
                    // Rola para baixo
                    box.scrollTop = box.scrollHeight;
                }
            } catch (error) { console.error(error); }
        }

        // 4. ENVIAR RESPOSTA
        async function enviarResposta() {
            const input = document.getElementById('texto-msg');
            const idDestino = document.getElementById('id-cliente-atual').value;
            const texto = input.value;
            const token = localStorage.getItem('token');

            if(!idDestino) return alert("Selecione um cliente na lista esquerda primeiro!");
            if(texto.trim() === "") return;

            try {
                await fetch('/api/chat/enviar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    // Manda o ID do destinatário para ser uma resposta direta
                    body: JSON.stringify({ texto: texto, destinatario_id: idDestino })
                });
                
                input.value = "";
                carregarMensagensDoCliente(idDestino); // Atualiza na hora
            } catch (error) {
                alert("Erro ao enviar");
            }
        }

        // Enviar com Enter
        document.getElementById('texto-msg').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') enviarResposta();
        });

        // Inicia o painel
        carregarContatos();
    </script>
</body>
</html>